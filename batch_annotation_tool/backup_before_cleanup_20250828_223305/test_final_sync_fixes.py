#!/usr/bin/env python3
"""
æœ€ç»ˆåŒæ­¥ä¿®å¤éªŒè¯æµ‹è¯•
ä¸“é—¨éªŒè¯ï¼š1.ç»Ÿè®¡å¹¶æœªæ›´æ–°ï¼Œ2.åˆ‡æ¢å›å»çŠ¶æ€ä¹Ÿæœªæ›´æ–°
"""

import sys
import os
from pathlib import Path

# æ·»åŠ srcç›®å½•åˆ°Pythonè·¯å¾„
current_file = Path(__file__).resolve()
project_root = current_file.parent
src_dir = project_root / "src"

if str(src_dir) not in sys.path:
    sys.path.insert(0, str(src_dir))

def run_final_sync_test():
    """è¿è¡Œæœ€ç»ˆåŒæ­¥æµ‹è¯•"""
    print("ğŸ”§ æœ€ç»ˆæ ‡æ³¨åŒæ­¥ä¿®å¤éªŒè¯")
    print("=" * 60)
    
    try:
        import tkinter as tk
        from ui.panoramic_annotation_gui import PanoramicAnnotationGUI
        
        # åˆ›å»ºGUIå®ä¾‹
        root = tk.Tk()
        app = PanoramicAnnotationGUI(root)
        
        print("âœ“ GUIåˆå§‹åŒ–æˆåŠŸ")
        print("\nğŸ¯ æœ¬æ¬¡ä¿®å¤çš„æ ¸å¿ƒé—®é¢˜:")
        print("1. ç»Ÿè®¡å¹¶æœªæ›´æ–° - ä¿å­˜æ ‡æ³¨åç»Ÿè®¡ä¿¡æ¯ä¸æ›´æ–°")
        print("2. åˆ‡æ¢å›å»çŠ¶æ€ä¹Ÿæœªæ›´æ–° - çŠ¶æ€æ˜¾ç¤ºä¸åŒæ­¥ï¼Œä¸æ˜¾ç¤ºæ—¶é—´æˆ³")
        
        print("\nğŸ›   å·²å®æ–½çš„ä¿®å¤æªæ–½:")
        print("âœ“ åœ¨save_current_annotation_internal()ä¸­æ·»åŠ å¤šé‡å¼ºåˆ¶UIåˆ·æ–°")
        print("âœ“ åœ¨å¯¼èˆªæ–¹æ³•ä¸­æ·»åŠ å»¶è¿Ÿå¼ºåˆ¶åˆ·æ–°æœºåˆ¶")
        print("âœ“ åœ¨load_current_slice()ä¸­æ·»åŠ å»¶è¿Ÿå¯¼èˆªåˆ·æ–°")
        print("âœ“ æ·»åŠ _delayed_navigation_refresh()å»¶è¿ŸåŒæ­¥æ–¹æ³•")
        print("âœ“ æ·»åŠ _force_navigation_refresh()å¼ºåˆ¶å¯¼èˆªåˆ·æ–°æ–¹æ³•")
        print("âœ“ æ·»åŠ _verify_and_retry_sync()éªŒè¯é‡è¯•æ–¹æ³•")
        print("âœ“ å¢å¼ºload_existing_annotation()æ–¹æ³•çš„æ—¶é—´æˆ³åŒæ­¥")
        print("âœ“ æ·»åŠ å…¨é¢çš„DEBUGè¾“å‡ºè¿½è¸ªåŒæ­¥è¿‡ç¨‹")
        
        print("\nğŸ“ æµ‹è¯•æ­¥éª¤:")
        print("1. é€‰æ‹©åŒ…å«å…¨æ™¯å›¾çš„ç›®å½•")
        print("2. ç‚¹å‡»'åŠ è½½æ•°æ®'")
        print("3. è¿›è¡Œä»¥ä¸‹æµ‹è¯•åºåˆ—:")
        print("   a) å¯¹å½“å‰å­”ä½è¿›è¡Œæ ‡æ³¨ï¼ˆé€‰æ‹©ç”Ÿé•¿çº§åˆ«ï¼‰")
        print("   b) ç‚¹å‡»'ä¿å­˜å¹¶ä¸‹ä¸€ä¸ª' - è§‚å¯Ÿç»Ÿè®¡æ˜¯å¦ç«‹å³æ›´æ–°")
        print("   c) ç‚¹å‡»'ä¸Šä¸€ä¸ª'è¿”å›åˆšæ‰æ ‡æ³¨çš„å­”ä½")
        print("   d) éªŒè¯çŠ¶æ€æ˜¯å¦æ˜¾ç¤ºæ—¶é—´æˆ³è€Œé'é…ç½®å¯¼å…¥'")
        print("   e) éªŒè¯ç»Ÿè®¡æ•°æ®æ˜¯å¦æ­£ç¡®åæ˜ æ ‡æ³¨çŠ¶æ€")
        
        print("\nğŸ” æœŸæœ›çš„ä¿®å¤æ•ˆæœ:")
        print("âœ… ä¿å­˜åç»Ÿè®¡ç«‹å³æ›´æ–°ï¼Œæ˜¾ç¤ºæ­£ç¡®çš„é˜´æ€§/å¼±ç”Ÿé•¿/é˜³æ€§æ•°é‡")
        print("âœ… åˆ‡æ¢å›å·²æ ‡æ³¨å­”ä½æ—¶ï¼ŒçŠ¶æ€æ˜¾ç¤ºï¼š'çŠ¶æ€: å·²æ ‡æ³¨ (MM-DD HH:MM:SS) - çº§åˆ«'")
        print("âœ… é…ç½®å¯¼å…¥çš„å­”ä½ä»æ˜¾ç¤ºï¼š'çŠ¶æ€: é…ç½®å¯¼å…¥ - çº§åˆ«'")
        print("âœ… ç•Œé¢å®Œå…¨åŒæ­¥ï¼Œæ— å»¶è¿Ÿæˆ–ä¸ä¸€è‡´é—®é¢˜")
        print("âœ… åœ¨æ§åˆ¶å°çœ‹åˆ°è¯¦ç»†çš„DEBUGè¾“å‡ºè·Ÿè¸ªåˆ·æ–°è¿‡ç¨‹")
        
        print("\nğŸš€ æŠ€æœ¯äº®ç‚¹:")
        print("â€¢ å¤šé‡å¼ºåˆ¶UIåˆ·æ–°ï¼šupdate_idletasks() + update()")
        print("â€¢ å»¶è¿ŸéªŒè¯æœºåˆ¶ï¼šafter_idle() + after() ç¡®ä¿å¼‚æ­¥æ›´æ–°åŒæ­¥")
        print("â€¢ åˆ†å±‚åˆ·æ–°ç­–ç•¥ï¼šç«‹å³åˆ·æ–° + çŸ­å»¶è¿Ÿåˆ·æ–° + å¯¼èˆªå»¶è¿Ÿåˆ·æ–°")
        print("â€¢ å¤šæ£€æŸ¥ç‚¹éªŒè¯ï¼šä¿å­˜åã€åŠ è½½åã€å¯¼èˆªåã€å»¶è¿ŸéªŒè¯")
        print("â€¢ æ™ºèƒ½æ—¶é—´æˆ³åŒæ­¥ï¼šåªå¯¹enhanced_manualæ ‡æ³¨å¤„ç†æ—¶é—´æˆ³")
        
        print(f"\nğŸ® å¯åŠ¨æµ‹è¯•GUI...")
        
        # å¯åŠ¨GUIä¸»å¾ªç¯
        root.mainloop()
        
        return True
        
    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == '__main__':
    print("ğŸ”§ æ ‡æ³¨åŒæ­¥é—®é¢˜æœ€ç»ˆä¿®å¤éªŒè¯")
    print("è§£å†³é—®é¢˜ï¼š1.ç»Ÿè®¡å¹¶æœªæ›´æ–°ï¼Œ2.åˆ‡æ¢å›å»çŠ¶æ€ä¹Ÿæœªæ›´æ–°")
    print()
    
    success = run_final_sync_test()
    
    if success:
        print("\nâœ… æµ‹è¯•ç¯å¢ƒå¯åŠ¨æˆåŠŸ")
        print("è¯·æŒ‰ç…§ä¸Šè¿°æµ‹è¯•æ­¥éª¤è¿›è¡ŒéªŒè¯")
        print("åœ¨æ§åˆ¶å°è§‚å¯ŸDEBUGè¾“å‡ºä»¥ç¡®è®¤ä¿®å¤ç”Ÿæ•ˆ")
    else:
        print("\nâŒ æµ‹è¯•ç¯å¢ƒå¯åŠ¨å¤±è´¥")
    
    print("\nğŸ“‹ éªŒè¯æ¸…å•:")
    print("[ ] ä¿å­˜æ ‡æ³¨åç»Ÿè®¡ç«‹å³æ›´æ–°")
    print("[ ] åˆ‡æ¢åˆ°å…¶ä»–å­”ä½åå†åˆ‡æ¢å›æ¥ï¼ŒçŠ¶æ€æ˜¾ç¤ºæ—¶é—´æˆ³")
    print("[ ] ç»Ÿè®¡æ•°æ®å‡†ç¡®åæ˜ æ ‡æ³¨çŠ¶æ€")
    print("[ ] æ§åˆ¶å°æœ‰è¯¦ç»†DEBUGè¾“å‡º")
    print("[ ] ç•Œé¢å“åº”æµç•…ï¼Œæ— å»¶è¿Ÿé—®é¢˜")
    
    sys.exit(0 if success else 1)