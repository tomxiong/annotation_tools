# 概要设计与实施计划（模型建议导入与采纳）

版本：v0.1
范围：对应需求规格 v0.3（P0 聚焦，P1 展望）

## 一、输入/输出与数据边界
- 既有导出：维持 m13.json 结构与含义不变（不写入模型建议或新增字段）。
- 模型导入：读取 m16_inference_results.json（样例路径：d:\dev\annotation_tools\example\m16_inference_results.json）。建议格式见需求文档附录：predictions[{hole_index,label,confidence}]。
- 内存态：为每个（panoramic_id, hole_number）可维护 0..1 条 model_suggestion，用于 UI 呈现与采纳，不持久化到 m13。

## 二、总体架构
- ModelSuggestionImportService（新）：
  - 职责：读取/校验 m16 JSON；按数据集/全景/孔位映射生成 suggestions_map；容错（缺字段、越界孔号、重复记录以最后一条为准并告警）。
  - 接口：load_from_json(path)-> suggestions_map；merge_into_session(session, suggestions_map)。
- HoleManager（现有，扩展）：
  - 增加模型视图数据访问：get_model_suggestion(panoramic_id,hole)->Optional[Suggestion]；
  - 提供采纳操作：adopt_model_suggestion(panoramic_id,hole)->None（将建议写入人工结果对象）。
- UI：
  - hole_manager.py / hole_config_panel.py：新增“视图切换（人工/模型/CFG）”“采纳模型建议”，并对差异字段高亮。
- 导出链路：
  - 不修改现有 ConfigFileService 写出逻辑；仅在导出时提示存在“未采纳建议”数量与定位入口。

## 三、数据模型（内存态）
- Suggestion
  - fields：growth_level: str（+/-/trace 等），growth_pattern?: list[str]，interference_factors?: list[str]，model_confidence?: float，model_name?: str，model_version?: str
- SuggestionsMap
  - dict[(panoramic_id: str, hole_number: int)] -> Suggestion
- Annotation（现有）
  - 不改写导出结构；在运行期通过 HoleManager 关联 suggestion。

## 四、关键流程
1) 导入模型建议
   - 选择 m16 JSON -> ImportService 解析 -> 生成 suggestions_map -> 注入 HoleManager 会话并标记到各孔位。
2) 视图切换与差异高亮
   - UI 读取人工/CFG/模型三视图数据；计算字段差异（level/pattern/interference）并以颜色或 chip 高亮。
3) 逐一采纳
   - 点击“采纳模型建议”-> HoleManager.adopt_model_suggestion -> 更新人工结果 -> 刷新 UI -> 建议状态从“待采纳”变为“已采纳/无差异”。
4) 导出提示
   - 触发导出 -> 若存在未采纳建议，弹出非阻断提示（显示数量与跳转入口）。

## 五、接口与文件影响清单（P0）
- 新增：src/services/model_suggestion_import_service.py
  - def load_from_json(path:str)->SuggestionsMap
  - def merge_into_session(session, suggestions:SuggestionsMap)->None
- 扩展：src/services/hole_manager.py
  - def get_model_suggestion(panoramic_id:str,hole:int)->Optional[Suggestion]
  - def adopt_model_suggestion(panoramic_id:str,hole:int)->None
- 扩展：src/ui/hole_config_panel.py
  - 新增视图切换（人工/模型/CFG）UI 控件与状态；“采纳”按钮；差异高亮渲染。
- 扩展：src/ui/panoramic_annotation_gui.py（或同类入口）
  - 文件导入入口：绑定到 ImportService；导出时的提示逻辑。
- 不变：src/services/config_file_service.py（m13 读写逻辑保持）

## 六、异常与边界
- JSON 不合法：提示并拒绝导入；
- hole_index 越界：忽略该条并计入警告；
- 重复（同孔多条）：以最后一条为准并记录 warning；
- 缺少 confidence：允许导入，UI 显示为“—”；
- 模型仅给出正/负：仅映射 growth_level；其他维度保持空/沿用人工。

## 七、实施计划与 Sprints
- Sprint 1（P0 全量）— 预估 3-5 天
  1) 新建 ImportService 与解析单元测试
  2) HoleManager 增加 suggestions 接入与采纳 API
  3) UI：详情面板视图切换与“采纳”按钮、差异高亮
  4) 导出提示未采纳逻辑
  5) 集成测试与冒烟
- Sprint 2（P1 部分）— 预估 4-6 天
  1) 过滤器：按“有建议/有差异/置信度区间”过滤
  2) 批量采纳：对过滤结果与选中范围
  3) 未采纳检查清单视图
  4) Sidecar（记录建议与采纳轨迹）
- Sprint 3（P1 后续/可选）— 预估 3-4 天
  1) CLI 子命令：import-pred / adopt-batch / export-check
  2) 审计日志导出

## 八、测试矩阵（P0）
- 单元：
  - 解析：合法/缺字段/越界/重复/空 predictions；
  - 采纳：覆盖人工空值/覆盖已有值；撤销由现有 Undo 体系验证。
- 集成：
  - 导入->视图切换->差异高亮->逐一采纳->导出提示；
  - 未导入建议时的回归路径。

## 九、风险与对策
- UI 变更影响现有交互：采用 feature flag / 视图默认仍为“人工”；
- JSON 口径不一致：在 ImportService 中做宽松解析与日志提示。