## 修订说明 v0.3（按用户反馈收敛）
- 不引入“确认/否决”流程；统一使用“采纳/不采纳模型建议”的术语，最终导出始终以人工结果为准。
- 模型结果定位为“建议（suggestion）”，必须显示“模型置信度（model_confidence）”；其含义与人工标注信心不同，当前阶段不引入“人工置信度”。
- UI 要求：支持“模型/CFG/人工”视图切换与差异高亮，突出未采纳的模型建议。
- P0 不提供“按阈值批量采纳”和“一次性覆盖”能力；这些能力移至后续阶段（P1）。
- 导出保持 m13.json 结构不变，不写入模型建议或新增字段；存在未采纳建议时仅给出提示但不阻断导出。
- 移除性能目标条目，后续如需再单独度量与优化。

# 模型结果导入与人工采纳：需求规格说明书（v0.3）

- 目标：在现有全景标注工具中，加载“模型批量判读结果”为建议，提供视图切换与差异高亮，并支持逐一采纳；不改变既有导出结构与下游兼容。

## 1. 术语与状态定义（收敛版）
- 标注来源（source）：
  - none：尚无人工结果；
  - cfg：从 cfg/既有文件加载的人工结果；
  - model（suggestion）：从模型导入的建议，仅内存态显示，不直接写入导出；
  - human：人工编辑/最终结果。
- 状态视角（供 UI 呈现）：
  - unlabelled：未有人工结果；
  - cfg_loaded：存在来自 cfg 的人工结果；
  - model_suggested：存在模型建议但尚未采纳到人工结果；
  - human_final：人工最终结果（可能来自采纳模型建议或手动编辑）。
- 模型置信度（model_confidence）：0..1，仅对模型建议有意义，用于 UI 显示与（P1）过滤/排序。

## 2. 用户故事与验收标准（P0 聚焦 + P1 预告）
1) 作为标注员，我希望导入模型建议后，界面能高亮与当前人工结果的差异，并可逐一“采纳”。
- 验收（P0）：
  - 导入后在孔位列表/缩略图上显示“有模型建议”的显著标识；
  - 详情面板可切换“人工/模型/CFG”视图，对比差异；
  - 点击“采纳模型建议”后，建议值覆盖为人工结果并即时生效。

2) 作为标注员，我需要看到模型置信度，以决定是否采纳。
- 验收（P0）：模型视图显示 model_confidence（保留两位小数），不与人工置信度混用。

3) 作为标注员/负责人，我希望导出不被未采纳建议阻断，但能收到提醒并可快速定位。
- 验收（P0）：导出动作若存在“未采纳建议”，弹出提示与定位入口（不阻断）。

4) 作为标注员，我希望按条件筛选并批量采纳提高效率。
- 验收（P1）：提供过滤（例如：仅显示存在模型建议/仅显示差异项），在过滤集合上批量执行“采纳”。

## 3. 功能需求清单（聚焦 P0）
- 导入：
  - 从本地选择模型结果 JSON（m16）导入到当前数据集会话；
  - 健壮解析与字段映射（见附录格式）。
- 展示：
  - 在孔位单元与详情面板中显示“模型建议”与“人工结果”，支持视图切换；
  - 差异高亮（level/pattern/interference_factors 的字段差异）；
  - 显示 model_confidence。
- 操作：
  - 逐一采纳：将模型建议覆盖到人工结果；
  - 取消采纳：通过手动编辑/恢复为原人工值实现；
  - 不提供“一键覆盖”与“阈值批量采纳”（移动至 P1）。
- 导出：
  - 保持 m13.json 结构与字段不变；
  - 存在未采纳建议时，导出弹提示但不阻断。

（P1 扩展）
- 过滤与批量：按“有建议/有差异/置信度区间”等过滤并批量采纳；
- Sidecar：写入/回放建议与采纳轨迹（旁路，不改 cfg/m13）。

## 4. 状态模型与状态机（简化版）
- 模型建议结构（内存态，不写出）：
  - suggestion: { growth_level, growth_pattern?, interference_factors?, model_confidence, model_name?, model_version? }
- 关键迁移：
  - none|cfg_loaded -> model_suggested：导入模型建议并建立映射；
  - model_suggested -> human_final：用户点击“采纳”后，建议覆盖为人工结果；
  - human_final -> human_final：用户进一步手动微调。
- 说明：若模型仅输出正/负（label 粒度较粗），则仅建议 growth_level，其余维度由人工补齐。

## 5. 架构与改动点（不破坏现有导出）
- 数据模型：
  - 不修改现有导出数据结构；
  - 在会话内维护 suggestions_map（键：panoramic_id + hole_number），存放模型建议与置信度；
  - 采纳动作仅更新内存中的人工结果对象。
- 服务层：
  - 新增 ModelSuggestionImportService：解析 m16 JSON、校验/映射并生成 suggestions_map；
  - 通过 HoleManager/Config 服务将建议与孔位绑定。
- UI：
  - 在 panoramic_annotation_gui/hole_config_panel 中增加“视图切换（人工/模型/CFG）”“采纳模型建议”按钮与差异高亮；
  - 在缩略图/孔位列表增加“有建议”的可视徽标。
- 导出：
  - 沿用现有 m13.json 生成逻辑；不写入建议与新字段。
- Sidecar（P1）：
  - dataset.sidecar.json 记录建议与采纳轨迹；可回放。

## 6. 非功能需求（更新）
- 易用性：统一快捷键、清晰图例、可撤销（基础撤销已存在则沿用）；
- 兼容性：未导入模型建议时功能不受影响；
- 可追溯：操作日志最小化记录（P1 由 sidecar 增强）。

## 7. 分阶段实施计划
- P0（最小可用）：
  - 导入适配器（m16 JSON -> suggestions_map）；
  - UI 视图切换 + 差异高亮 + 逐一采纳；
  - 导出提示未采纳（不阻断）。
- P1（效率增强）：
  - 过滤器与批量采纳；
  - Sidecar 写入/回放；
  - 未采纳检查清单视图。
- P2（治理与自动化）：
  - CLI 子命令；
  - 审计日志导出。

## 8. 风险与缓解
- 模型输出粒度不足：仅建议可映射字段，其他维度保留人工编辑；
- 建议与人工差异过多：通过差异高亮与筛选缓解（P1）。

## 9. 测试计划（概要）
- 单元：导入解析/字段映射/置信度范围校验；
- 集成：导入->视图切换->差异高亮->逐一采纳->导出提示；
- 回归：未导入模型建议时，现有流程不回归失败。

## 10. 附录：预测导入 JSON 建议格式（与 m16_inference_results.json 对齐）

示例（精简自实际文件，用于开发与验收口径）：
```
{
  "dataset_name": "M16_AI_Inference_Results",
  "description": "M16多任务模型AI推理结果",
  "created_time": "2025-09-02T19:07:28.588731",
  "total_annotations": 960,
  "saved_annotations": 960,
  "processed_directories": ["EB10000030", "EB10000031"],
  "model_info": {
    "model_path": "d:\\dev\\bioastModel\\onnx_models\\m16_multitask_mobilenetv3.onnx",
    "input_size": "70x70",
    "tasks": ["growth_level", "growth_pattern", "interference_factors", "fine_grained"]
  },
  "annotations": [
    {
      "image_id": "hole_25",
      "image_path": "ni/EB10000030/hole_25.png",
      "panoramic_id": "EB10000030",
      "hole_number": 25,
      "features": {
        "microbe_type": "unknown",
        "growth_level": "positive",
        "growth_pattern": "clustered",
        "interference_factors": ["pores"],
        "confidence": 0.9999759197
      },
      "annotation_metadata": {
        "annotator": "M16_AI_Model",
        "annotation_time": "2025-09-02T19:07:22.775633",
        "model_version": "M16_multitask_v1.0",
        "confidence_scores": {
          "growth_level": 0.9999759197,
          "growth_pattern": 0.9993756413,
          "interference_factors": [0.7279301882]
        }
      }
    }
  ]
}
```

字段与映射（P0 实施最小集）：
- 定位键：panoramic_id:string + hole_number:int（用于与当前数据集孔位匹配）。
- 建议值来源：
  - growth_level <- annotations[].features.growth_level（枚举：positive/negative/...）；
  - growth_pattern <- annotations[].features.growth_pattern（如有）；
  - interference_factors <- annotations[].features.interference_factors（如有，string[]）；
  - model_confidence <- annotations[].features.confidence（如缺可为空“—”显示）。
- 元信息（可选显示）：
  - model_name/model_version <- annotations[].annotation_metadata.model_version；
  - 细粒度置信度 <- annotations[].annotation_metadata.confidence_scores（仅展示，不参与P0逻辑）。

验收要点（与 UI/流程联动）：
- 正确解析上述结构；对缺字段、越界孔位、重复记录给出容错与告警；
- 成功建立 suggestions_map 并在 UI 中以“模型视图”显示；
- 逐一采纳后，人工结果实时更新；导出仍保持 m13.json 原结构不变。