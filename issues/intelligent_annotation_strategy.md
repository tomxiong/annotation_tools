# 全景图像标注工具 - 智能标注策略文档

## 版本信息
- **版本**: v2.1
- **更新时间**: 2025-09-10
- **作者**: 标注工具开发团队
- **更新内容**: 优化模型视图显示策略，模型视图下优先显示预测结果

## 策略概述

本文档定义了全景图像标注工具在不同视图模式下的智能标注策略，包括视图切换、导航操作、设置复制等场景的处理逻辑。

## 一、视图模式定义

### 1.1 人工视图 (ViewMode.MANUAL)
- **用途**: 人工标注和审核
- **数据来源优先级**: 人工标注 > CFG配置 > 默认设置
- **特点**: 支持设置复制功能，优先显示人工标注

### 1.2 模型视图 (ViewMode.MODEL)
- **用途**: 查看和验证模型预测结果
- **数据来源优先级**: 模型预测 > CFG配置 > 默认设置
- **特点**: 主要用于查看模型预测，图像上同时显示已有标注状态
- **重要**: 无论是否有人工标注，都优先显示模型预测结果

## 二、数据来源类型

### 2.1 人工标注 (Manual Annotation)
- **标识**: `annotation_source` = `enhanced_manual` 或 `manual`
- **特征**: 包含完整的标注数据和时间戳
- **优先级**: 在人工视图中最高，在模型视图中作为参考显示

### 2.2 模型预测 (Model Prediction)
- **标识**: 存在于 `hole_manager` 的建议数据中
- **特征**: 包含模型置信度
- **优先级**: 在模型视图中最高

### 2.3 CFG配置 (Config Import)
- **标识**: `annotation_source` = `config`
- **特征**: 从配置文件导入的预设标注
- **优先级**: 中等

### 2.4 默认设置 (Default Settings)
- **特征**: 系统默认值（阴性、清亮等）
- **优先级**: 最低

## 三、智能标注策略

### 3.1 视图切换策略

#### 3.1.1 人工视图 → 模型视图切换
```
策略流程（优先显示模型预测）：
1. 检查是否有模型预测结果
   ├─ 有模型预测 → 显示模型预测结果
   └─ 无模型预测 → 继续检查
2. 检查是否有CFG配置
   ├─ 有CFG配置 → 显示CFG配置
   └─ 无CFG配置 → 显示默认设置
3. 图像标注状态显示
   ├─ 有人工标注 → 在切片图像上显示标注指示器
   └─ 无人工标注 → 不显示标注指示器

注意：模型视图下，面板显示的是模型预测，图像上显示的是标注状态
```

#### 3.1.2 模型视图 → 人工视图切换
```
策略流程（优先显示人工标注）：
1. 检查当前孔位是否有人工标注
   ├─ 有人工标注 → 显示人工标注
   └─ 无人工标注 → 继续检查
2. 检查是否有CFG配置
   ├─ 有CFG配置 → 显示CFG配置
   └─ 无CFG配置 → 显示默认设置

注意：人工视图下不显示模型预测结果
```

### 3.2 导航操作策略

#### 3.2.1 普通导航（上一个/下一个/跳转）
**目的**: 查看不同孔位的标注状态，不执行设置复制

**人工视图下的显示策略**:
```
面板显示优先级：
1. 有人工标注 → 显示人工标注
2. 无人工标注 + 有CFG配置 → 显示CFG配置
3. 无人工标注 + 无CFG配置 → 显示默认设置

图像显示：
- 有人工标注时显示标注指示器
```

**模型视图下的显示策略**:
```
面板显示优先级：
1. 有模型预测 → 显示模型预测（无论是否有人工标注）
2. 无模型预测 + 有CFG配置 → 显示CFG配置
3. 无模型预测 + 无CFG配置 → 显示默认设置

图像显示：
- 有人工标注时显示标注指示器（与模型预测并存）
- 有模型预测时可显示预测置信度信息
```

#### 3.2.2 保存并下一个操作
**目的**: 保存当前标注并智能设置下一个孔位，启用设置复制功能

**执行流程**:
```
1. 保存当前孔位的人工标注
2. 导航到下一个孔位
3. 执行智能设置继承策略（见3.3节）
```

### 3.3 智能设置继承策略（仅限"保存并下一个"）

#### 3.3.1 策略优先级
```
策略0: 模型视图优先处理
├─ 视图模式 = 模型视图
├─ 有模型预测 → 应用模型预测（无论是否有人工标注）
└─ 无模型预测 → 继续下一策略

策略1: 用户手动标注保护（仅人工视图）
├─ 视图模式 = 人工视图 AND 有人工标注 → 显示人工标注（不覆盖）
└─ 其他情况 → 继续下一策略

策略2: CFG配置智能判断
├─ 有CFG配置 → 比较生长级别
│   ├─ 生长级别相同 → 复制当前设置
│   └─ 生长级别不同 → 应用CFG配置
└─ 无CFG配置 → 继续下一策略

策略3: 默认处理
└─ 复制当前设置（连续孔位常见情况）
```

#### 3.3.2 详细策略说明

**策略0: 模型视图优先处理**
```
条件: current_view_mode == ViewMode.MODEL
执行:
  IF 有模型预测:
    显示模型预测结果（忽略已有人工标注）
    图像上同时显示人工标注状态（如果有）
    返回 "apply_model"
  ELSE:
    继续执行策略1
```

**策略1: 用户手动标注保护（仅人工视图）**
```
条件: 视图模式 == 人工视图 AND 下一个孔位有人工标注
执行:
  显示已有人工标注
  返回 "apply_existing"
作用: 仅在人工视图下防止覆盖用户的标注成果
```

**策略2: CFG配置智能判断**
```
条件: 下一个孔位有CFG配置
执行:
  IF 当前生长级别 == CFG生长级别:
    复制当前设置（连续性优化）
    返回 "keep_current"
  ELSE:
    应用CFG配置
    返回 "apply_cfg"
```

**策略3: 默认处理**
```
条件: 下一个孔位无CFG配置
执行:
  复制当前设置
  返回 "keep_current"
作用: 处理大部分连续孔位的情况
```

### 3.4 数据显示格式

#### 3.4.1 标注状态显示
```
人工视图:
- cfg-{growth_level} 已标注 ({timestamp})  # 有CFG+已标注
- cfg-{growth_level} 未标注               # 有CFG+未标注
- 已标注 ({timestamp})                   # 无CFG+已标注
- 无CFG                                  # 无CFG+未标注

模型视图:
- cfg-{growth_level} 模型预测 已标注 ({timestamp})  # 有CFG+有预测+已标注
- cfg-{growth_level} 模型预测                     # 有CFG+有预测+未标注
- 模型预测 已标注 ({timestamp})                   # 无CFG+有预测+已标注
- 模型预测                                       # 无CFG+有预测+未标注
- cfg-{growth_level} 无模型预测 已标注 ({timestamp}) # 有CFG+无预测+已标注
- cfg-{growth_level} 无模型预测                     # 有CFG+无预测+未标注
- 无模型预测 已标注 ({timestamp})                   # 无CFG+无预测+已标注
- 无模型预测                                       # 无CFG+无预测+未标注
```

#### 3.4.2 详细标注信息显示
```
格式: 微生物类型 | 生长级别 | 生长模式 | 置信度 | 干扰因素

人工视图:
- 优先显示人工标注的详细信息
- 无人工标注时显示CFG配置信息
- 无CFG配置时不显示详细信息

模型视图:
- 优先显示模型预测详细信息（末尾标记"预测"）
- 无模型预测时显示CFG配置信息
- 无CFG配置时不显示详细信息
- 图像上独立显示人工标注状态指示器
```

#### 3.4.3 图像显示策略
```
人工视图:
- 显示人工标注指示器（绿色圆圈等）
- 不显示模型预测相关图形

模型视图:
- 显示人工标注指示器（如果有，绿色圆圈）
- 显示模型预测置信度信息（如果有，文字或颜色编码）
- 两种信息可以并存显示
```

## 四、微生物类型自动判断

### 4.1 文件名规则
```python
def determine_microbe_type_from_filename(panoramic_id: str) -> str:
    """根据全景图文件名前两位字符判断微生物类型"""
    if panoramic_id and len(panoramic_id) >= 2:
        prefix = panoramic_id[:2].upper()
        if prefix == "FG":
            return "fungi"  # 真菌
    return "bacteria"      # 细菌（默认）
```

### 4.2 应用场景
- 新建标注时的默认微生物类型
- CFG配置导入时的微生物类型推断
- 模型预测结果的微生物类型验证

## 五、实现要点

### 5.1 关键判断条件

#### 5.1.1 人工标注识别
```python
def is_manual_annotation(annotation):
    return (hasattr(annotation, 'annotation_source') and 
            annotation.annotation_source in ['enhanced_manual', 'manual'])
```

#### 5.1.2 模型预测检查
```python
def has_model_prediction(hole_number):
    return (hasattr(self, 'hole_manager') and 
            self.hole_manager and 
            self.hole_manager.has_hole_suggestion(hole_number))
```

#### 5.1.3 CFG配置检查
```python
def has_cfg_config(hole_number):
    config_data = self.get_current_panoramic_config()
    return config_data and hole_number in config_data
```

#### 5.1.4 视图模式特殊处理
```python
def load_annotation_for_view_mode(self, hole_number):
    """根据视图模式加载不同优先级的数据"""
    if self.current_view_mode == ViewMode.MODEL:
        # 模型视图：优先显示模型预测
        if self.has_model_prediction(hole_number):
            return self.load_model_prediction(hole_number)
        # 降级到CFG或默认
    else:
        # 人工视图：优先显示人工标注
        manual_annotation = self.get_manual_annotation(hole_number)
        if manual_annotation:
            return manual_annotation
        # 降级到CFG或默认
```

### 5.2 性能优化策略

#### 5.2.1 设置复制优化
- **批量操作**: 减少UI刷新次数
- **预构建映射**: O(1)查找替代O(n)搜索
- **轻量级刷新**: `update_idletasks()` 替代 `update()`

#### 5.2.2 导航跳转优化
- **智能预检查**: 避免多次重复设置
- **一次性加载**: 合并标注加载步骤
- **优先级逻辑**: 减少不必要的处理

#### 5.2.3 视图切换优化
- **缓存机制**: 缓存模型预测和人工标注数据
- **延迟更新**: 仅在必要时更新图像显示
- **状态同步**: 确保面板和图像显示一致

## 六、用户操作指南

### 6.1 推荐工作流程

#### 6.1.1 初次标注
```
1. 选择人工视图
2. 使用"保存并下一个"进行连续标注
3. 系统会自动复制相同生长级别的设置
4. 遇到不同生长级别时会自动应用CFG配置
```

#### 6.1.2 模型结果验证
```
1. 导入模型预测结果
2. 切换到模型视图
3. 使用普通导航查看各孔位的预测结果
4. 面板显示模型预测，图像上显示已标注状态
5. 对需要修正的孔位切换到人工视图进行标注
```

#### 6.1.3 标注审核
```
1. 加载已有标注文件
2. 在人工视图查看已标注结果
3. 在模型视图查看模型预测与人工标注的对比
4. 对需要修改的孔位重新标注
```

### 6.2 视图使用建议

#### 6.2.1 人工视图
- **主要用途**: 人工标注、审核、修正
- **显示内容**: 优先显示人工标注，无标注时显示CFG配置
- **操作建议**: 使用"保存并下一个"提高标注效率

#### 6.2.2 模型视图
- **主要用途**: 查看模型预测结果、验证模型性能
- **显示内容**: 优先显示模型预测，图像同时显示标注状态
- **操作建议**: 主要用于查看，不建议进行大量标注操作

### 6.3 注意事项

1. **设置复制仅在"保存并下一个"时生效**
2. **普通导航不会复制设置，仅用于查看**
3. **人工视图下，人工标注优先级最高，不会被自动覆盖**
4. **模型视图下，模型预测优先级最高，但不覆盖图像上的标注显示**
5. **CFG配置作为辅助参考，可被人工标注覆盖**
6. **图像上的标注指示器独立于面板显示，可以并存**

## 七、性能监控与优化

### 7.1 性能监控功能
- **详细步骤计时**: 7个关键步骤的精确计时
- **按钮状态监控**: 禁用/启用的完整时序
- **视图切换性能**: 模型预测加载和显示的性能监控
- **智能优化建议**: 基于实际数据的参数调整建议

### 7.2 优化成果
```
设置应用性能: 589.7ms → 3.1ms (99.5%提升)
总操作时间: 2384.4ms → 1555.4ms (34.8%改善)
算法复杂度: O(n) → O(1) (数量级优化)
视图切换性能: < 50ms (新增监控指标)
```

## 八、策略优势

### 8.1 效率提升
- **连续性优化**: 大部分相同生长级别的孔位自动复制设置
- **智能判断**: 自动识别需要应用CFG配置的情况
- **数据保护**: 防止意外覆盖已有标注
- **视图专业化**: 每种视图专注于特定用途

### 8.2 数据质量
- **多数据源整合**: 人工标注、模型预测、CFG配置有机结合
- **优先级明确**: 不同视图下的数据优先级清晰
- **状态透明**: 清晰显示数据来源和状态
- **信息并存**: 模型视图下可同时查看预测和标注状态

### 8.3 用户体验
- **操作直观**: 不同操作产生不同结果，符合用户预期
- **信息丰富**: 提供详细的状态和来源信息
- **灵活切换**: 支持多种视图模式适应不同工作场景
- **专业分工**: 人工视图专注标注，模型视图专注验证

## 九、技术实现细节

### 9.1 核心方法

#### 9.1.1 智能设置继承
```python
def _apply_smart_inheritance_strategy(self, current_settings, next_hole_info, view_mode):
    """智能设置继承策略的核心实现"""
    # 策略0: 模型视图优先处理（修改后）
    if view_mode == ViewMode.MODEL:
        if self.has_model_prediction(next_hole_info['hole_number']):
            # 无论是否有人工标注，都显示模型预测
            self._load_model_view_data()
            return True, "apply_model"
    
    # 策略1-3的实现逻辑
```

#### 9.1.2 视图模式切换
```python
def _on_view_mode_changed(self):
    """视图模式变更的完整处理流程"""
    if self.current_view_mode == ViewMode.MODEL:
        # 模型视图：优先加载模型预测
        self._load_model_view_if_available()
    else:
        # 人工视图：优先加载人工标注
        self._load_manual_annotation_if_available()
    
    # 更新图像显示（包含标注指示器）
    self._update_image_display()
```

#### 9.1.3 导航跳转优化
```python
def load_current_slice(self):
    """优化的切片加载，根据视图模式加载不同数据"""
    # 基础图像加载
    self._load_slice_image()
    
    # 根据视图模式加载对应数据
    if self.current_view_mode == ViewMode.MODEL:
        self._load_for_model_view()
    else:
        self._load_for_manual_view()
    
    # 统一更新显示
    self._update_all_displays()
```

### 9.2 错误处理机制
- **安全属性访问**: `getattr(obj, 'attr', 'default')`
- **异常降级处理**: 确保基本功能可用
- **日志记录**: 详细的调试和错误信息
- **视图隔离**: 一个视图的错误不影响另一个视图

### 9.3 数据同步机制
- **面板-图像同步**: 确保面板显示和图像标注指示器一致
- **跨视图状态**: 维护人工标注状态在视图切换时的正确显示
- **实时更新**: 标注保存后立即更新所有相关显示

---

**文档维护**: 本策略文档应随系统功能更新而及时修订，确保与实际实现保持一致。

**最后更新**: 2025-09-10  
**主要变更**: 
- 优化模型视图显示策略，无论是否有人工标注都优先显示模型预测
- 完善图像显示策略，支持标注状态和模型预测信息并存
- 更新智能设置继承策略，模型视图下忽略人工标注优先级
- 增加视图专业化说明和使用建议

**下次审核**: 根据系统升级情况确定
